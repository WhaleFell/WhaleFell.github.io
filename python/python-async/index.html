<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><link rel="mask-icon" href="/images/favicon.ico"><title>Python asyncio å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘ | ğŸ˜Šè½è½ã®BlogğŸ˜Š</title><meta name="keywords" content="Coding, Python, ç¼–ç¨‹,åšå®¢,è®°å½•,æŠ€æœ¯,ç”Ÿæ´»,å‰ç«¯,æ‘„å½±,LGBT,è®¡ç®—æœº,ç½‘ç»œå®‰å…¨,Life,Cybersecurity,Python,Golang,Vue,Javascript,Java,Linux"><meta name="description" content="Python å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘"><meta property="og:type" content="article"><meta property="og:title" content="Python asyncio å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘"><meta property="og:url" content="https://www.whaleluo.top/python/python-async/index.html"><meta property="og:site_name" content="ğŸ˜Šè½è½ã®BlogğŸ˜Š"><meta property="og:description" content="Python å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘"><meta property="og:locale"><meta property="og:image" content="https://api.whaleluo.top/onedrive/file/?path=/picstorage/blog/img/Python-Asyncio-banner.png"><meta property="article:published_time" content="2021-08-18T11:37:48.000Z"><meta property="article:modified_time" content="2021-08-18T11:37:48.000Z"><meta property="article:author" content="WhaleFall"><meta property="article:tag" content="Coding"><meta property="article:tag" content="Python"><meta name="twitter:card" content="images&#x2F;favicon.ico"><meta name="twitter:image" content="https://api.whaleluo.top/onedrive/file/?path=/picstorage/blog/img/Python-Asyncio-banner.png"><link rel="stylesheet" href="/css/style/main.css"><link rel="stylesheet" id="hl-default-theme" href="https://api.whaleluo.top/file/?url=https://cdn.jsdelivr.net/npm/highlight.js@10.1.2/styles/atom-one-light.css" media="none"><link rel="stylesheet" id="hl-dark-theme" href="https://api.whaleluo.top/file/?url=https://cdn.jsdelivr.net/npm/highlight.js@10.1.2/styles/atom-one-dark.css" media="none"><link rel="stylesheet" href="/css/style/dark.css"><script src="/js/darkmode.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="google-site-verification" content="bka9Mdyvo7g1v-jQq8CzqcaY9zE2QGltMwsvO63rAUw"><meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="ğŸ˜Šè½è½ã®BlogğŸ˜Š" type="application/atom+xml"></head><body><div id="app" tabindex="-1"><header class="header"><div class="header__left"><a href="/" class="button"><span class="logo__text">è½è½ã®Blog</span></a></div><div class="header__right"><div class="navbar__menus"><a href="/" class="navbar-menu button">é¦–é¡µ</a> <a href="/tags/" class="navbar-menu button">æ ‡ç­¾</a> <a href="/archives/" class="navbar-menu button">å½’æ¡£</a> <a href="/categories/" class="navbar-menu button">ä¸»é¢˜</a> <a href="/friends/" class="navbar-menu button">å‹é“¾</a> <a href="/about/" class="navbar-menu button">å…³äº</a> <a href="/event/" class="navbar-menu button">å¤§äº‹è®°</a> <a href="/atom.xml" class="navbar-menu button">RSS</a></div><a href="/search/" id="btn-search"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="24" height="24" fill="currentColor" stroke="currentColor" stroke-width="32"><path d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z"></path></svg> </a><a href="javaScript:void(0);" id="btn-toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> </a><a class="dropdown-icon button" id="btn-dropdown" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="24" height="24" fill="none" stroke="currentColor" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round"><path fill="currentColor" d="M3.314,4.8h13.372c0.41,0,0.743-0.333,0.743-0.743c0-0.41-0.333-0.743-0.743-0.743H3.314c-0.41,0-0.743,0.333-0.743,0.743C2.571,4.467,2.904,4.8,3.314,4.8z M16.686,15.2H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,15.2,16.686,15.2z M16.686,9.257H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,9.257,16.686,9.257z"></path></svg></a><div class="dropdown-menus" id="dropdown-menus"><a href="/" class="dropdown-menu button">é¦–é¡µ</a> <a href="/tags/" class="dropdown-menu button">æ ‡ç­¾</a> <a href="/archives/" class="dropdown-menu button">å½’æ¡£</a> <a href="/categories/" class="dropdown-menu button">ä¸»é¢˜</a> <a href="/friends/" class="dropdown-menu button">å‹é“¾</a> <a href="/about/" class="dropdown-menu button">å…³äº</a> <a href="/event/" class="dropdown-menu button">å¤§äº‹è®°</a> <a href="/atom.xml" class="dropdown-menu button">RSS</a></div></div></header><main class="main"><div class="post-title"><h1 class="post-title__text">Python asyncio å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘</h1><div class="post-title__meta"><a href="/archives/2021/08/" class="post-meta__date button">2021-08-18</a> <span class="separate-dot"></span><a href="/categories/Python/" class="button">Python</a> <span id="busuanzi_container_page_pv" hidden><span class="separate-dot"></span> <span></span> <span id="busuanzi_value_page_pv"></span> <span>Views</span></span></div></div><aside class="post-side"><div class="post-side__toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%EF%BC%88coroutine%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">åç¨‹ï¼ˆcoroutineï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E2%80%94%E2%80%94-event-loop"><span class="toc-number">2.</span> <span class="toc-text">äº‹ä»¶å¾ªç¯â€”â€”(event_loop)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">è·å–äº‹ä»¶å¾ªç¯å¯¹è±¡çš„å‡ ç§æ–¹å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%BF%90%E8%A1%8C%E5%8D%8F%E7%A8%8B%E5%87%BD%E6%95%B0%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">é€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œåç¨‹å‡½æ•°çš„ä¸¤ç§æ–¹å¼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">Task ä»»åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1%EF%BC%88%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">åˆ›å»ºä»»åŠ¡ï¼ˆä¸¤ç§æ–¹æ³•ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">è·å–æŸä¸€ä¸ªä»»åŠ¡çš„æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E8%8E%B7%E5%8F%96"><span class="toc-number">4.</span> <span class="toc-text">å¼‚æ­¥å‡½æ•°çš„ç»“æœè·å–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asyncio-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.</span> <span class="toc-text">Asyncio å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬æ¨¡æ¿</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E6%9E%84%E9%80%A0%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">5.1.</span> <span class="toc-text">ç¬¬ä¸€æ­¥ï¼šæ„é€ äº‹ä»¶å¾ªç¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%B0%86%E4%B8%80%E4%B8%AA%E6%88%96%E8%80%85%E6%98%AF%E5%A4%9A%E4%B8%AA%E5%8D%8F%E7%A8%8B%E5%87%BD%E6%95%B0%E5%8C%85%E8%A3%85%E6%88%90%E4%BB%BB%E5%8A%A1-Task"><span class="toc-number">5.2.</span> <span class="toc-text">ç¬¬äºŒæ­¥ï¼šå°†ä¸€ä¸ªæˆ–è€…æ˜¯å¤šä¸ªåç¨‹å‡½æ•°åŒ…è£…æˆä»»åŠ¡ Task</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%80%9A%E8%BF%87%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%BF%90%E8%A1%8C"><span class="toc-number">5.3.</span> <span class="toc-text">ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-gather-%E5%92%8C-wait-%E6%95%B4%E5%90%88-Task-%E6%B3%A8%E5%86%8C%E5%A4%9A%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.1.</span> <span class="toc-text">ä½¿ç”¨ gather å’Œ wait æ•´åˆ Task æ³¨å†Œå¤šä¸ªæœåŠ¡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%85%B3%E9%97%AD%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">5.4.</span> <span class="toc-text">ç¬¬å››æ­¥ï¼šå…³é—­äº‹ä»¶å¾ªç¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">6.</span> <span class="toc-text">æ³¨æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E9%98%BB%E5%A1%9E%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.</span> <span class="toc-text">åç¨‹é˜»å¡é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5"><span class="toc-number">7.</span> <span class="toc-text">ä»£ç ç‰‡æ®µ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Gather-%E5%90%8C%E6%97%B6%E6%B3%A8%E5%86%8C%E5%A4%9A%E4%B8%AA%E4%BB%BB%E5%8A%A1%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%B9%B6%E5%8F%91"><span class="toc-number">7.1.</span> <span class="toc-text">ä½¿ç”¨ Gather åŒæ—¶æ³¨å†Œå¤šä¸ªä»»åŠ¡ï¼Œå®ç°å¹¶å‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5-%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.2.</span> <span class="toc-text">å¼‚æ­¥ + å¤šçº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Httpx-Aiohttp-%E4%B9%8B%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82"><span class="toc-number">7.3.</span> <span class="toc-text">Httpx Aiohttp ä¹‹å¼‚æ­¥è¯·æ±‚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B"><span class="toc-number">8.</span> <span class="toc-text">åç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E7%AD%89%E5%BE%85%E5%AF%B9%E8%B1%A1"><span class="toc-number">9.</span> <span class="toc-text">å¯ç­‰å¾…å¯¹è±¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B-1"><span class="toc-number">9.1.</span> <span class="toc-text">åç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1"><span class="toc-number">9.2.</span> <span class="toc-text">ä»»åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Futures"><span class="toc-number">9.3.</span> <span class="toc-text">Futures</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-Asyncio-%E5%8D%8F%E7%A8%8B"><span class="toc-number">10.</span> <span class="toc-text">è¿è¡Œ Asyncio åç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E8%BF%90%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.</span> <span class="toc-text">å¹¶å‘è¿è¡Œä»»åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%85%E6%97%B6"><span class="toc-number">12.</span> <span class="toc-text">è¶…æ—¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%AD%89%E5%BE%85"><span class="toc-number">13.</span> <span class="toc-text">ç®€å•ç­‰å¾…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%8D%8F%E7%A8%8B"><span class="toc-number">14.</span> <span class="toc-text">å®šä¹‰åç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%8D%8F%E7%A8%8B"><span class="toc-number">15.</span> <span class="toc-text">è¿è¡Œåç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83"><span class="toc-number">16.</span> <span class="toc-text">å›è°ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E5%8D%8F%E7%A8%8B"><span class="toc-number">17.</span> <span class="toc-text">å¤šä¸ªåç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#run-until-complete-%E5%92%8C-run-forever"><span class="toc-number">18.</span> <span class="toc-text">run_until_complete å’Œ run_forever</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Close-Loop"><span class="toc-number">19.</span> <span class="toc-text">Close Loop?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gather-vs-wait"><span class="toc-number">20.</span> <span class="toc-text">Gather vs. wait</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Timer"><span class="toc-number">21.</span> <span class="toc-text">Timer</span></a></li></ol></div></aside><a class="btn-toc button" id="btn-toc" tabindex="0"><svg viewBox="0 0 1024 1024" width="32" height="32" xmlns="http://www.w3.org/2000/svg"><path d="M128 256h64V192H128zM320 256h576V192H320zM128 544h64v-64H128zM320 544h576v-64H320zM128 832h64v-64H128zM320 832h576v-64H320z" fill="currentColor"></path></svg></a><div class="toc-menus" id="toc-menus"><div class="toc-title">Article Directory</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%EF%BC%88coroutine%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">åç¨‹ï¼ˆcoroutineï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E2%80%94%E2%80%94-event-loop"><span class="toc-number">2.</span> <span class="toc-text">äº‹ä»¶å¾ªç¯â€”â€”(event_loop)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">è·å–äº‹ä»¶å¾ªç¯å¯¹è±¡çš„å‡ ç§æ–¹å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%BF%90%E8%A1%8C%E5%8D%8F%E7%A8%8B%E5%87%BD%E6%95%B0%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">é€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œåç¨‹å‡½æ•°çš„ä¸¤ç§æ–¹å¼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">Task ä»»åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1%EF%BC%88%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">åˆ›å»ºä»»åŠ¡ï¼ˆä¸¤ç§æ–¹æ³•ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">è·å–æŸä¸€ä¸ªä»»åŠ¡çš„æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E8%8E%B7%E5%8F%96"><span class="toc-number">4.</span> <span class="toc-text">å¼‚æ­¥å‡½æ•°çš„ç»“æœè·å–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Asyncio-%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.</span> <span class="toc-text">Asyncio å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬æ¨¡æ¿</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E6%9E%84%E9%80%A0%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">5.1.</span> <span class="toc-text">ç¬¬ä¸€æ­¥ï¼šæ„é€ äº‹ä»¶å¾ªç¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%B0%86%E4%B8%80%E4%B8%AA%E6%88%96%E8%80%85%E6%98%AF%E5%A4%9A%E4%B8%AA%E5%8D%8F%E7%A8%8B%E5%87%BD%E6%95%B0%E5%8C%85%E8%A3%85%E6%88%90%E4%BB%BB%E5%8A%A1-Task"><span class="toc-number">5.2.</span> <span class="toc-text">ç¬¬äºŒæ­¥ï¼šå°†ä¸€ä¸ªæˆ–è€…æ˜¯å¤šä¸ªåç¨‹å‡½æ•°åŒ…è£…æˆä»»åŠ¡ Task</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%80%9A%E8%BF%87%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E8%BF%90%E8%A1%8C"><span class="toc-number">5.3.</span> <span class="toc-text">ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-gather-%E5%92%8C-wait-%E6%95%B4%E5%90%88-Task-%E6%B3%A8%E5%86%8C%E5%A4%9A%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.1.</span> <span class="toc-text">ä½¿ç”¨ gather å’Œ wait æ•´åˆ Task æ³¨å†Œå¤šä¸ªæœåŠ¡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%85%B3%E9%97%AD%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">5.4.</span> <span class="toc-text">ç¬¬å››æ­¥ï¼šå…³é—­äº‹ä»¶å¾ªç¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">6.</span> <span class="toc-text">æ³¨æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E9%98%BB%E5%A1%9E%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.</span> <span class="toc-text">åç¨‹é˜»å¡é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%89%87%E6%AE%B5"><span class="toc-number">7.</span> <span class="toc-text">ä»£ç ç‰‡æ®µ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Gather-%E5%90%8C%E6%97%B6%E6%B3%A8%E5%86%8C%E5%A4%9A%E4%B8%AA%E4%BB%BB%E5%8A%A1%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%B9%B6%E5%8F%91"><span class="toc-number">7.1.</span> <span class="toc-text">ä½¿ç”¨ Gather åŒæ—¶æ³¨å†Œå¤šä¸ªä»»åŠ¡ï¼Œå®ç°å¹¶å‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5-%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.2.</span> <span class="toc-text">å¼‚æ­¥ + å¤šçº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Httpx-Aiohttp-%E4%B9%8B%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82"><span class="toc-number">7.3.</span> <span class="toc-text">Httpx Aiohttp ä¹‹å¼‚æ­¥è¯·æ±‚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B"><span class="toc-number">8.</span> <span class="toc-text">åç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E7%AD%89%E5%BE%85%E5%AF%B9%E8%B1%A1"><span class="toc-number">9.</span> <span class="toc-text">å¯ç­‰å¾…å¯¹è±¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B-1"><span class="toc-number">9.1.</span> <span class="toc-text">åç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1"><span class="toc-number">9.2.</span> <span class="toc-text">ä»»åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Futures"><span class="toc-number">9.3.</span> <span class="toc-text">Futures</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-Asyncio-%E5%8D%8F%E7%A8%8B"><span class="toc-number">10.</span> <span class="toc-text">è¿è¡Œ Asyncio åç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E8%BF%90%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-number">11.</span> <span class="toc-text">å¹¶å‘è¿è¡Œä»»åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%85%E6%97%B6"><span class="toc-number">12.</span> <span class="toc-text">è¶…æ—¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%AD%89%E5%BE%85"><span class="toc-number">13.</span> <span class="toc-text">ç®€å•ç­‰å¾…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%8D%8F%E7%A8%8B"><span class="toc-number">14.</span> <span class="toc-text">å®šä¹‰åç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%8D%8F%E7%A8%8B"><span class="toc-number">15.</span> <span class="toc-text">è¿è¡Œåç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83"><span class="toc-number">16.</span> <span class="toc-text">å›è°ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E5%8D%8F%E7%A8%8B"><span class="toc-number">17.</span> <span class="toc-text">å¤šä¸ªåç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#run-until-complete-%E5%92%8C-run-forever"><span class="toc-number">18.</span> <span class="toc-text">run_until_complete å’Œ run_forever</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Close-Loop"><span class="toc-number">19.</span> <span class="toc-text">Close Loop?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gather-vs-wait"><span class="toc-number">20.</span> <span class="toc-text">Gather vs. wait</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Timer"><span class="toc-number">21.</span> <span class="toc-text">Timer</span></a></li></ol></div><article class="post post__with-toc content-card"><div class="post__header"><div class="post-thumbnail lazy" data-bg="https://api.whaleluo.top/onedrive/file/?path=/picstorage/blog/img/Python-Asyncio-banner.png"></div><div class="post__expire" id="post-expired-notify"><p>This article was last updated on &lt;span id=&#34;expire-date&#34;&gt;&lt;/span&gt; days ago, the information described in the article may be outdated.</p></div><script>(() => {
            var update = Date.parse("2021-08-18"),
                date = new Date(),
                now = date.getTime(),
                expire = now - update,
                expire_days = Math.floor(expire/(24*3600*1000));
            if (expire_days >= 120) {
                document.querySelectorAll('#expire-date')[0].innerHTML = expire_days;
                document.querySelectorAll('#post-expired-notify')[0].style.display = 'block';
            }
        })();</script></div><div class="post__content"><p><img src="https://api.whaleluo.top/onedrive/file/?path=/picstorage/blog/img/Python-Asyncio-banner.png&webp=true" class="lazy" data-srcset="https://api.whaleluo.top/onedrive/file/?path=/picstorage/blog/img/Python-Asyncio-banner.png&webp=true" srcset="https://api.whaleluo.top/onedrive/file/?path=/PicStorage/blog/loading.gif" alt="image"></p><h1 id="Python-Asyncio-å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘"><a href="#Python-Asyncio-å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘" class="headerlink" title="Python Asyncio å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘"></a>Python Asyncio å¼‚æ­¥åç¨‹ç™¾ä¸‡å¹¶å‘</h1><h2 id="åç¨‹ï¼ˆcoroutineï¼‰"><a href="#åç¨‹ï¼ˆcoroutineï¼‰" class="headerlink" title="åç¨‹ï¼ˆcoroutineï¼‰"></a>åç¨‹ï¼ˆcoroutineï¼‰</h2><p>æœ¬è´¨å°±æ˜¯ä¸€ä¸ª <strong>å‡½æ•°</strong></p><h2 id="äº‹ä»¶å¾ªç¯â€”â€”-event-loop"><a href="#äº‹ä»¶å¾ªç¯â€”â€”-event-loop" class="headerlink" title="äº‹ä»¶å¾ªç¯â€”â€”(event_loop)"></a>äº‹ä»¶å¾ªç¯â€”â€”(event_loop)</h2><p><strong>åç¨‹å‡½æ•°</strong>ï¼Œä¸æ˜¯åƒæ™®é€šå‡½æ•°é‚£æ ·ç›´æ¥è°ƒç”¨è¿è¡Œçš„ï¼Œå¿…é¡»<strong>æ·»åŠ åˆ°äº‹ä»¶å¾ªç¯</strong>ä¸­ï¼Œç„¶åç”±<strong>äº‹ä»¶å¾ªç¯</strong>å»è¿è¡Œï¼Œå•ç‹¬è¿è¡Œåç¨‹å‡½æ•°æ˜¯ä¸ä¼šæœ‰ç»“æœçš„ï¼Œçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">say_after_time</span>(<span class="hljs-params">delay,what</span>):
        <span class="hljs-keyword">await</span> asyncio.sleep(delay)
        <span class="hljs-built_in">print</span>(what)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å¼€å§‹æ—¶é—´ä¸ºï¼š <span class="hljs-subst">&#123;time.time()&#125;</span>&quot;</span>)
        <span class="hljs-keyword">await</span> say_after_time(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;hello&quot;</span>)
        <span class="hljs-keyword">await</span> say_after_time(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;world&quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ç»“æŸæ—¶é—´ä¸ºï¼š <span class="hljs-subst">&#123;time.time()&#125;</span>&quot;</span>)

loop=asyncio.get_event_loop()    <span class="hljs-comment">#åˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡</span>
<span class="hljs-comment"># loop=asyncio.new_event_loop()   #ä¸ä¸Šé¢ç­‰ä»·ï¼Œåˆ›å»ºæ–°çš„äº‹ä»¶å¾ªç¯</span>
loop.run_until_complete(main())  <span class="hljs-comment">#é€šè¿‡äº‹ä»¶å¾ªç¯å¯¹è±¡è¿è¡Œåç¨‹å‡½æ•°</span>
loop.close()</code></pre><p>åœ¨ python3.6 ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœæˆ‘ä»¬å•ç‹¬åƒæ‰§è¡Œæ™®é€šå‡½æ•°é‚£æ ·æ‰§è¡Œä¸€ä¸ªåç¨‹å‡½æ•°ï¼Œåªä¼šè¿”å›ä¸€ä¸ª coroutine å¯¹è±¡ï¼ˆpython3.7ï¼‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>main()
&lt;coroutine <span class="hljs-built_in">object</span> main at <span class="hljs-number">0x1053bb7c8</span>&gt;</code></pre><h3 id="è·å–äº‹ä»¶å¾ªç¯å¯¹è±¡çš„å‡ ç§æ–¹å¼"><a href="#è·å–äº‹ä»¶å¾ªç¯å¯¹è±¡çš„å‡ ç§æ–¹å¼" class="headerlink" title="è·å–äº‹ä»¶å¾ªç¯å¯¹è±¡çš„å‡ ç§æ–¹å¼"></a>è·å–äº‹ä»¶å¾ªç¯å¯¹è±¡çš„å‡ ç§æ–¹å¼</h3><pre><code class="hljs plaintext">loop = asyncio.get_event_loop()</code></pre><p>å®ƒæ˜¯ python3.7 ä¸­æ–°æ·»åŠ çš„ï¼Œ<strong>è·å¾—ä¸€ä¸ªäº‹ä»¶å¾ªç¯</strong>ï¼Œå¦‚æœå½“å‰çº¿ç¨‹<strong>è¿˜æ²¡æœ‰äº‹ä»¶å¾ªç¯</strong>ï¼Œåˆ™<strong>åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯ loopï¼›</strong></p><h3 id="é€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œåç¨‹å‡½æ•°çš„ä¸¤ç§æ–¹å¼"><a href="#é€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œåç¨‹å‡½æ•°çš„ä¸¤ç§æ–¹å¼" class="headerlink" title="é€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œåç¨‹å‡½æ•°çš„ä¸¤ç§æ–¹å¼"></a>é€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œåç¨‹å‡½æ•°çš„ä¸¤ç§æ–¹å¼</h3><ol><li>åˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡ loopï¼Œå³ <code>asyncio.get_event_loop()</code>ï¼Œ<strong>é€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œåç¨‹å‡½æ•°</strong>.</li><li>ç›´æ¥é€šè¿‡ <code>asyncio.run(function_name)</code> è¿è¡Œ<strong>åç¨‹å‡½æ•°ã€‚</strong></li></ol><p><strong>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé¦–å…ˆ run å‡½æ•°æ˜¯ python3.7 ç‰ˆæœ¬æ–°æ·»åŠ çš„ï¼Œå‰é¢çš„ç‰ˆæœ¬æ˜¯æ²¡æœ‰çš„ï¼›</strong></p><p>å…¶æ¬¡ï¼Œè¿™ä¸ª run å‡½æ•°æ€»æ˜¯ <strong>ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯å¹¶åœ¨ run ç»“æŸä¹‹åå…³é—­äº‹ä»¶å¾ªç¯</strong>ï¼Œæ‰€ä»¥ï¼Œå¦‚æœåœ¨ <strong>åŒä¸€ä¸ªçº¿ç¨‹</strong>ä¸­å·²ç»æœ‰äº†ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œåˆ™<strong>ä¸èƒ½å†ä½¿ç”¨è¿™ä¸ªå‡½æ•°</strong>äº†ï¼Œå› ä¸º <strong>åŒä¸€ä¸ªçº¿ç¨‹ä¸èƒ½æœ‰ä¸¤ä¸ªäº‹ä»¶å¾ªç¯</strong>ï¼Œè€Œä¸”è¿™ä¸ª run å‡½æ•°<strong>ä¸èƒ½åŒæ—¶è¿è¡Œä¸¤æ¬¡</strong>ï¼Œå› ä¸ºä»–å·²ç»åˆ›å»ºä¸€ä¸ªäº†ã€‚å³<strong>åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ˜¯ä¸å…è®¸æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ loop çš„</strong>ã€‚</p><h2 id="Task-ä»»åŠ¡"><a href="#Task-ä»»åŠ¡" class="headerlink" title="Task ä»»åŠ¡"></a>Task ä»»åŠ¡</h2><h3 id="åˆ›å»ºä»»åŠ¡ï¼ˆä¸¤ç§æ–¹æ³•ï¼‰"><a href="#åˆ›å»ºä»»åŠ¡ï¼ˆä¸¤ç§æ–¹æ³•ï¼‰" class="headerlink" title="åˆ›å»ºä»»åŠ¡ï¼ˆä¸¤ç§æ–¹æ³•ï¼‰"></a>åˆ›å»ºä»»åŠ¡ï¼ˆä¸¤ç§æ–¹æ³•ï¼‰</h3><ol><li><p><code>task = asyncio.create_task(coro())</code> <strong>è¿™æ˜¯ 3.7 ç‰ˆæœ¬æ–°æ·»åŠ çš„</strong>,<strong>å¯ä»¥ä¼ åç¨‹å‡½æ•°</strong></p></li><li><p><code>task = asyncio.ensure_future(coro())</code></p></li><li><p>ä¹Ÿå¯ä»¥ï¼š</p><pre><code class="hljs python">loop.create_future()
loop.create_task(coro)</code></pre></li></ol><h3 id="è·å–æŸä¸€ä¸ªä»»åŠ¡çš„æ–¹æ³•"><a href="#è·å–æŸä¸€ä¸ªä»»åŠ¡çš„æ–¹æ³•" class="headerlink" title="è·å–æŸä¸€ä¸ªä»»åŠ¡çš„æ–¹æ³•"></a>è·å–æŸä¸€ä¸ªä»»åŠ¡çš„æ–¹æ³•</h3><ol><li><p><code>task=asyncio.current_task(loop=None)</code><br>è¿”å›åœ¨æŸä¸€ä¸ªæŒ‡å®šçš„ loop ä¸­ï¼Œ<strong>å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡</strong>ï¼Œ<strong>å¦‚æœæ²¡æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œåˆ™è¿”å› None</strong>ï¼›<br>å¦‚æœ loop ä¸º Noneï¼Œ<strong>åˆ™é»˜è®¤ä¸ºåœ¨å½“å‰çš„äº‹ä»¶å¾ªç¯ä¸­è·å–</strong>.</p></li><li><p><code>asyncio.all_tasks(loop=None)</code><br>è¿”å›æŸä¸€ä¸ª<strong>loop ä¸­è¿˜æ²¡æœ‰ç»“æŸçš„ä»»åŠ¡</strong></p></li></ol><h2 id="å¼‚æ­¥å‡½æ•°çš„ç»“æœè·å–"><a href="#å¼‚æ­¥å‡½æ•°çš„ç»“æœè·å–" class="headerlink" title="å¼‚æ­¥å‡½æ•°çš„ç»“æœè·å–"></a>å¼‚æ­¥å‡½æ•°çš„ç»“æœè·å–</h2><p>å¯¹äºå¼‚æ­¥ç¼–ç¨‹ã€å¼‚æ­¥å‡½æ•°è€Œè¨€ï¼Œæœ€é‡è¦çš„å°±æ˜¯ <strong>å¼‚æ­¥å‡½æ•°è°ƒç”¨ç»“æŸä¹‹åï¼Œè·å–å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ <strong>æ¥è·å–å‡½æ•°çš„è¿”å›å€¼</strong>ï¼Œç¬¬ä¸€æ˜¯ç›´æ¥é€šè¿‡ <code>Task.result()</code> æ¥è·å–ï¼›ç¬¬äºŒç§æ˜¯ <strong>ç»‘å®šä¸€ä¸ªå›è°ƒå‡½æ•°</strong> æ¥è·å–ï¼Œ<strong>å³å‡½æ•°æ‰§è¡Œå®Œæ¯•åè°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥è·å–å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼ã€‚</strong></p><ol><li><p>ç›´æ¥é€šè¿‡ <code>result</code> æ¥è·å–.</p><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time


<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello1</span>(<span class="hljs-params">a,b</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello world 01 begin&quot;</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">3</span>)  <span class="hljs-comment">#æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡3ç§’</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello again 01 end&quot;</span>)
    <span class="hljs-keyword">return</span> a+b

coroutine=hello1(<span class="hljs-number">10</span>,<span class="hljs-number">5</span>)
loop = asyncio.get_event_loop()                <span class="hljs-comment">#ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºäº‹ä»¶å¾ªç¯</span>
task = asyncio.ensure_future(coroutine)         <span class="hljs-comment">#ç¬¬äºŒæ­¥:å°†å¤šä¸ªåç¨‹å‡½æ•°åŒ…è£…æˆä»»åŠ¡åˆ—è¡¨</span>
loop.run_until_complete(task)                  <span class="hljs-comment">#ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œ</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-------------------------------------&#x27;</span>)
<span class="hljs-built_in">print</span>(task.result())
loop.close()

<span class="hljs-string">&#x27;&#x27;&#x27;è¿è¡Œç»“æœä¸º</span>
<span class="hljs-string">Hello world 01 begin</span>
<span class="hljs-string">Hello again 01 end</span>
<span class="hljs-string">-------------------------------------</span>
<span class="hljs-string">15</span>
<span class="hljs-string">&#x27;&#x27;&#x27;</span></code></pre></li><li><p>é€šè¿‡å®šä¹‰<strong>å›è°ƒå‡½æ•°</strong>æ¥è·å–</p></li></ol><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello1</span>(<span class="hljs-params">a,b</span>):
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello world 01 begin&quot;</span>)
      <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">3</span>)  <span class="hljs-comment"># æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡3ç§’</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello again 01 end&quot;</span>)
    <span class="hljs-keyword">return</span> a+b

<span class="hljs-keyword">def</span> <span class="hljs-title function_">callback</span>(<span class="hljs-params">future</span>):   <span class="hljs-comment"># å®šä¹‰çš„å›è°ƒå‡½æ•°,éœ€è¦ä¼ futureå‚æ•°</span>
    <span class="hljs-built_in">print</span>(future.result())

loop = asyncio.get_event_loop()                <span class="hljs-comment"># ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºäº‹ä»¶å¾ªç¯</span>
task = asyncio.ensure_future(hello1(<span class="hljs-number">10</span>,<span class="hljs-number">5</span>))       <span class="hljs-comment"># ç¬¬äºŒæ­¥:å°†å¤šä¸ªåç¨‹å‡½æ•°åŒ…è£…æˆä»»åŠ¡</span>
task.add_done_callback(callback)                      <span class="hljs-comment"># å¹¶è¢«ä»»åŠ¡ç»‘å®šä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œé»˜è®¤ä¼ å…¥ç»“æœå‚æ•°</span>

loop.run_until_complete(task)                  <span class="hljs-comment"># ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œ</span>
loop.close()                                   <span class="hljs-comment"># ç¬¬å››æ­¥ï¼šå…³é—­äº‹ä»¶å¾ªç¯</span>


<span class="hljs-string">&#x27;&#x27;&#x27;è¿è¡Œç»“æœä¸ºï¼š</span>
<span class="hljs-string">Hello world 01 begin</span>
<span class="hljs-string">Hello again 01 end</span>
<span class="hljs-string">15</span>
<span class="hljs-string">&#x27;&#x27;&#x27;</span></code></pre><p>æ³¨æ„ï¼šæ‰€è°“çš„å›è°ƒå‡½æ•°ï¼Œå°±æ˜¯æŒ‡åç¨‹å‡½æ•° coroutine <strong>æ‰§è¡Œç»“æŸæ—¶å€™ä¼šè°ƒç”¨å›è°ƒå‡½æ•°</strong>ã€‚å¹¶é€šè¿‡ <strong>å‚æ•° future è·å–åç¨‹æ‰§è¡Œçš„ç»“æœ</strong>ã€‚æˆ‘ä»¬åˆ›å»ºçš„<strong>task å’Œå›è°ƒé‡Œçš„ future å¯¹è±¡</strong>ï¼Œå®é™…ä¸Šæ˜¯ <strong>åŒä¸€ä¸ªå¯¹è±¡</strong>ï¼Œå› ä¸º task æ˜¯ future çš„å­ç±»ã€‚</p><h2 id="Asyncio-å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬æ¨¡æ¿"><a href="#Asyncio-å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬æ¨¡æ¿" class="headerlink" title="Asyncio å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬æ¨¡æ¿"></a>Asyncio å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬æ¨¡æ¿</h2><h3 id="ç¬¬ä¸€æ­¥ï¼šæ„é€ äº‹ä»¶å¾ªç¯"><a href="#ç¬¬ä¸€æ­¥ï¼šæ„é€ äº‹ä»¶å¾ªç¯" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šæ„é€ äº‹ä»¶å¾ªç¯"></a>ç¬¬ä¸€æ­¥ï¼šæ„é€ äº‹ä»¶å¾ªç¯</h3><ol><li><p><code>loop = asyncio.get_running_loop()</code><br>è¿”å›ï¼ˆè·å–ï¼‰åœ¨å½“å‰çº¿ç¨‹ä¸­<strong>æ­£åœ¨è¿è¡Œçš„äº‹ä»¶å¾ªç¯</strong>ï¼Œå¦‚æœæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„äº‹ä»¶å¾ªç¯ï¼Œåˆ™ä¼šæ˜¾ç¤ºé”™è¯¯ï¼›å®ƒæ˜¯<strong>python3.7 ä¸­æ–°æ·»åŠ çš„</strong></p></li><li><p><code>loop = asyncio.get_event_loop()</code><br><strong>è·å¾—ä¸€ä¸ªäº‹ä»¶å¾ªç¯</strong>ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰äº‹ä»¶å¾ªç¯ï¼Œåˆ™<strong>åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯ loop</strong>ï¼›</p></li><li><p><code>loop=asyncio.set_event_loop(thread)</code><br>è®¾ç½®ä¸€ä¸ªäº‹ä»¶å¾ªç¯<strong>ä¸ºå½“å‰çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯</strong>ï¼›</p></li><li><p><code>loop=asyncio.new_event_loop()</code><br><strong>åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯</strong></p></li></ol><h3 id="ç¬¬äºŒæ­¥ï¼šå°†ä¸€ä¸ªæˆ–è€…æ˜¯å¤šä¸ªåç¨‹å‡½æ•°åŒ…è£…æˆä»»åŠ¡-Task"><a href="#ç¬¬äºŒæ­¥ï¼šå°†ä¸€ä¸ªæˆ–è€…æ˜¯å¤šä¸ªåç¨‹å‡½æ•°åŒ…è£…æˆä»»åŠ¡-Task" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šå°†ä¸€ä¸ªæˆ–è€…æ˜¯å¤šä¸ªåç¨‹å‡½æ•°åŒ…è£…æˆä»»åŠ¡ Task"></a>ç¬¬äºŒæ­¥ï¼šå°†ä¸€ä¸ªæˆ–è€…æ˜¯å¤šä¸ªåç¨‹å‡½æ•°åŒ…è£…æˆä»»åŠ¡ Task</h3><ol><li><p><code>task = asyncio.create_task(coro(å‚æ•°åˆ—è¡¨))</code><br><strong>è¿™æ˜¯ 3.7 ç‰ˆæœ¬æ–°æ·»åŠ çš„</strong></p></li><li><p><code>task = asyncio.ensure_future(coro(å‚æ•°åˆ—è¡¨))</code><br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ <code>Task.result()</code> è·å– <strong>åç¨‹å‡½æ•°ç»“æœ</strong>çš„ æ—¶å€™ï¼Œä½¿ç”¨ <code>asyncio.create_task()</code> å´ä¼šæ˜¾ç¤ºé”™ï¼Œä½†æ˜¯ä½¿ç”¨ <code>asyncio.ensure_future</code> å´æ­£ç¡®</p></li></ol><h3 id="ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œ"><a href="#ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œ" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œ"></a>ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡äº‹ä»¶å¾ªç¯è¿è¡Œ</h3><ol><li><p><code>loop.run_until_complete(asyncio.wait(tasks))</code><br>é€šè¿‡ <code>asyncio.wait()</code>â€‹<strong>æ•´åˆå¤šä¸ª task</strong></p></li><li><p><code>loop.run_until_complete(asyncio.gather(tasks))</code><br>é€šè¿‡ <code>asyncio.gather()</code>â€‹<strong>æ•´åˆå¤šä¸ª task</strong></p></li><li><p><code>loop.run_until_complete(task_1)</code><br><strong>å•ä¸ªä»»åŠ¡åˆ™ä¸éœ€è¦æ•´åˆ</strong></p></li><li><p><del>loop.run_forever()</del><br><del>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•åœ¨æ–°ç‰ˆæœ¬å·²ç»å–æ¶ˆï¼Œä¸å†æ¨èä½¿ç”¨ï¼Œå› ä¸ºä½¿ç”¨èµ·æ¥ä¸ç®€æ´</del></p></li></ol><h4 id="ä½¿ç”¨-gather-å’Œ-wait-æ•´åˆ-Task-æ³¨å†Œå¤šä¸ªæœåŠ¡"><a href="#ä½¿ç”¨-gather-å’Œ-wait-æ•´åˆ-Task-æ³¨å†Œå¤šä¸ªæœåŠ¡" class="headerlink" title="ä½¿ç”¨ gather å’Œ wait æ•´åˆ Task æ³¨å†Œå¤šä¸ªæœåŠ¡"></a>ä½¿ç”¨ <code>gather</code> å’Œ <code>wait</code> æ•´åˆ Task æ³¨å†Œå¤šä¸ªæœåŠ¡</h4><ol><li><p><strong>å‚æ•°å½¢å¼ä¸ä¸€æ ·</strong></p><p><strong>gather</strong>çš„å‚æ•°ä¸º coroutines_or_futures,å³å¦‚è¿™ç§å½¢å¼ï¼š</p><pre><code class="hljs python">tasks = asyncio.gather(*[task1,task2,task3])
tasks = asyncio.gather(task1,task2,task3)
loop.run_until_complete(tasks)</code></pre><p><strong>wait</strong>çš„å‚æ•°ä¸º<strong>åˆ—è¡¨æˆ–è€…é›†åˆ</strong>çš„å½¢å¼ï¼Œå¦‚ä¸‹:</p><pre><code class="hljs python">tasks = asyncio.wait([task1,task2,task3])
loop.run_until_complete(tasks)</code></pre></li><li><p><strong>è¿”å›çš„å€¼ä¸ä¸€æ ·</strong></p><p><strong>gather è¿”å›çš„æ˜¯æ¯ä¸€ä¸ªä»»åŠ¡è¿è¡Œçš„ç»“æœ</strong>ï¼š</p></li></ol><p>è¦ä»¥ä¼ å…¥ä¸€ä¸ªåˆ—è¡¨å¯å˜å‚æ•°</p><p><strong>å¯å˜å‚æ•°å…è®¸åœ¨è°ƒç”¨å‚æ•°çš„æ—¶å€™ä¼ å…¥å¤šä¸ªå‚æ•°,è¿™äº›å‚æ•°åœ¨è°ƒç”¨æ—¶è¢«è‡ªåŠ¨ç»„è£…ä¸ºä¸€ä¸ª tuple</strong></p><p><code>results = await asyncio.gather(*[tasks])</code></p><p><code>results = await asyncio.gather(task1,task2,task3)</code></p><p><strong>wait è¿”å› dones æ˜¯å·²ç»å®Œæˆçš„ä»»åŠ¡ï¼Œpending æ˜¯æœªå®Œæˆçš„ä»»åŠ¡ï¼Œéƒ½æ˜¯é›†åˆç±»å‹</strong>ï¼š<br><code>done, pending = yield from asyncio.wait(fs)</code></p><p>ç®€å•æ¥è¯´ï¼š<strong>async.wait ä¼šè¿”å›ä¸¤ä¸ªå€¼:done å’Œ pending</strong>ï¼Œdone ä¸ºå·²å®Œæˆçš„åç¨‹ Taskï¼Œpending ä¸ºè¶…æ—¶æœªå®Œæˆçš„åç¨‹ Taskï¼Œ<strong>éœ€é€šè¿‡ future.result è°ƒç”¨ Task çš„ resultã€‚</strong><br>è€Œ <code>async.gather</code> è¿”å›çš„æ˜¯<strong>å·²å®Œæˆ Task çš„ result</strong>ã€‚</p><h3 id="ç¬¬å››æ­¥ï¼šå…³é—­äº‹ä»¶å¾ªç¯"><a href="#ç¬¬å››æ­¥ï¼šå…³é—­äº‹ä»¶å¾ªç¯" class="headerlink" title="ç¬¬å››æ­¥ï¼šå…³é—­äº‹ä»¶å¾ªç¯"></a>ç¬¬å››æ­¥ï¼šå…³é—­äº‹ä»¶å¾ªç¯</h3><pre><code class="hljs python">loop.close()
<span class="hljs-comment"># ä»¥ä¸Šç¤ºä¾‹éƒ½æ²¡æœ‰è°ƒç”¨ loop.closeï¼Œå¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚æ‰€ä»¥åˆ°åº•è¦ä¸è¦è°ƒ loop.close å‘¢ï¼Ÿ</span></code></pre><h2 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2><h3 id="åç¨‹é˜»å¡é—®é¢˜"><a href="#åç¨‹é˜»å¡é—®é¢˜" class="headerlink" title="åç¨‹é˜»å¡é—®é¢˜"></a>åç¨‹é˜»å¡é—®é¢˜</h3><p><strong>å¼‚æ­¥æ–¹å¼ä¾ç„¶ä¼šæœ‰é˜»å¡çš„</strong>ï¼Œå½“æˆ‘ä»¬å®šä¹‰çš„å¾ˆå¤šä¸ªå¼‚æ­¥æ–¹æ³• <strong>å½¼æ­¤ä¹‹é—´æœ‰ä¸€æ¥</strong> çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼Œæˆ‘å¿…é¡»è¦ç­‰åˆ°å‡½æ•° 1 æ‰§è¡Œå®Œæ¯•ï¼Œ<strong>å‡½æ•° 2 éœ€è¦ç”¨åˆ°å‡½æ•° 1 çš„è¿”å›å€¼</strong>ï¼Œå°±ä¼šé€ æˆ<strong>é˜»å¡</strong>ï¼Œè¿™ä¹Ÿæ˜¯å¼‚æ­¥ç¼–ç¨‹çš„éš¾ç‚¹ä¹‹ä¸€ï¼Œå¦‚ä½•åˆç†é…ç½®è¿™äº›èµ„æºï¼Œå°½é‡<strong>å‡å°‘å‡½æ•°ä¹‹é—´çš„æ˜ç¡®ä¾èµ–</strong>ï¼Œè¿™æ˜¯å¾ˆé‡è¦çš„ã€‚</p><p><strong>ç»“è®º</strong>ï¼šåœ¨æœ‰<strong>å¾ˆå¤šä¸ªå¼‚æ­¥æ–¹å¼</strong>çš„æ—¶å€™ï¼Œä¸€å®šè¦å°½é‡é¿å…è¿™ç§ <strong>å¼‚æ­¥å‡½æ•°çš„ç›´æ¥è°ƒç”¨</strong>ï¼Œè¿™å’ŒåŒæ­¥æ˜¯æ²¡ä»€ä¹ˆåŒºåˆ«çš„ï¼Œä¸€å®šè¦ <strong>é€šè¿‡äº‹ä»¶å¾ªç¯ loop</strong>ï¼Œ<strong>â€œè®©äº‹ä»¶å¾ªç¯åœ¨å„ä¸ªå¼‚æ­¥å‡½æ•°ä¹‹é—´ä¸åœæ¸¸èµ°â€</strong>ï¼Œè¿™æ ·æ‰ä¸ä¼šé€ æˆé˜»å¡ã€‚</p><h2 id="ä»£ç ç‰‡æ®µ"><a href="#ä»£ç ç‰‡æ®µ" class="headerlink" title="ä»£ç ç‰‡æ®µ"></a>ä»£ç ç‰‡æ®µ</h2><h3 id="ä½¿ç”¨-Gather-åŒæ—¶æ³¨å†Œå¤šä¸ªä»»åŠ¡ï¼Œå®ç°å¹¶å‘"><a href="#ä½¿ç”¨-Gather-åŒæ—¶æ³¨å†Œå¤šä¸ªä»»åŠ¡ï¼Œå®ç°å¹¶å‘" class="headerlink" title="ä½¿ç”¨ Gather åŒæ—¶æ³¨å†Œå¤šä¸ªä»»åŠ¡ï¼Œå®ç°å¹¶å‘"></a>ä½¿ç”¨ Gather åŒæ—¶æ³¨å†Œå¤šä¸ªä»»åŠ¡ï¼Œå®ç°å¹¶å‘</h3><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello1</span>(<span class="hljs-params">a,b</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello world 01 begin&quot;</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">3</span>)  <span class="hljs-comment">#æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡3ç§’</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello again 01 end&quot;</span>)
    <span class="hljs-keyword">return</span> a+b

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello2</span>(<span class="hljs-params">a,b</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello world 02 begin&quot;</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)   <span class="hljs-comment">#æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡2ç§’</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello again 02 end&quot;</span>)
    <span class="hljs-keyword">return</span> a-b

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello3</span>(<span class="hljs-params">a,b</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello world 03 begin&quot;</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">4</span>)   <span class="hljs-comment">#æ¨¡æ‹Ÿè€—æ—¶ä»»åŠ¡4ç§’</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello again 03 end&quot;</span>)
    <span class="hljs-keyword">return</span> a*b

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():  <span class="hljs-comment">#å°è£…å¤šä»»åŠ¡çš„å…¥å£å‡½æ•°</span>
    <span class="hljs-comment"># ç”¨åˆ—è¡¨è¡¨è¾¾å¼åˆ›å»ºä»»åŠ¡</span>
    tasks = [
        asyncio.ensure_future(hello1(<span class="hljs-number">10</span>,<span class="hljs-number">5</span>))
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)
    ]
    results = <span class="hljs-keyword">await</span> asyncio.gather(tasks)
    <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:    <span class="hljs-comment">#é€šè¿‡è¿­ä»£è·å–å‡½æ•°çš„ç»“æœï¼Œæ¯ä¸€ä¸ªå…ƒç´ å°±æ˜¯ç›¸å¯¹åº”çš„ä»»åŠ¡çš„è¿”å›å€¼ï¼Œé¡ºåºéƒ½æ²¡å˜</span>
        <span class="hljs-built_in">print</span>(result)


loop = asyncio.get_event_loop()
loop.run_until_complete(main())
loop.close()</code></pre><h3 id="å¼‚æ­¥-å¤šçº¿ç¨‹"><a href="#å¼‚æ­¥-å¤šçº¿ç¨‹" class="headerlink" title="å¼‚æ­¥ + å¤šçº¿ç¨‹"></a>å¼‚æ­¥ + å¤šçº¿ç¨‹</h3><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> asyncio,time,threading

<span class="hljs-comment">#éœ€è¦æ‰§è¡Œçš„è€—æ—¶å¼‚æ­¥ä»»åŠ¡</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">func</span>(<span class="hljs-params">num</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;å‡†å¤‡è°ƒç”¨func,å¤§çº¦è€—æ—¶<span class="hljs-subst">&#123;num&#125;</span>&#x27;</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(num)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;è€—æ—¶<span class="hljs-subst">&#123;num&#125;</span>ä¹‹å,funcå‡½æ•°è¿è¡Œç»“æŸ&#x27;</span>)

<span class="hljs-comment">#å®šä¹‰ä¸€ä¸ªä¸“é—¨åˆ›å»ºäº‹ä»¶å¾ªç¯loopçš„å‡½æ•°ï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­å¯åŠ¨å®ƒ</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">start_loop</span>(<span class="hljs-params">loop</span>):
    asyncio.set_event_loop(loop)
    <span class="hljs-comment"># å¯åŠ¨äº‹ä»¶å¾ªç¯å¹¶æŒç»­è¿è¡Œ</span>
    loop.run_forever()

<span class="hljs-comment">#å®šä¹‰ä¸€ä¸ªmainå‡½æ•°</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    coroutine1 = func(<span class="hljs-number">3</span>)
    coroutine2 = func(<span class="hljs-number">2</span>)
    coroutine3 = func(<span class="hljs-number">1</span>)

    new_loop = asyncio.new_event_loop()                        <span class="hljs-comment">#åœ¨å½“å‰çº¿ç¨‹ä¸‹åˆ›å»ºæ—¶é—´å¾ªç¯ï¼Œï¼ˆæœªå¯ç”¨ï¼‰ï¼Œåœ¨start_loopé‡Œé¢å¯åŠ¨å®ƒ</span>
    t = threading.Thread(target=start_loop,args=(new_loop,))   <span class="hljs-comment">#é€šè¿‡å½“å‰çº¿ç¨‹å¼€å¯æ–°çš„çº¿ç¨‹å»å¯åŠ¨äº‹ä»¶å¾ªç¯</span>
    t.start()

    asyncio.run_coroutine_threadsafe(coroutine1, new_loop)  <span class="hljs-comment">#è¿™å‡ ä¸ªæ˜¯å…³é”®ï¼Œä»£è¡¨åœ¨æ–°çº¿ç¨‹ä¸­äº‹ä»¶å¾ªç¯ä¸æ–­â€œæ¸¸èµ°â€æ‰§è¡Œ</span>
    asyncio.run_coroutine_threadsafe(coroutine2, new_loop)
    asyncio.run_coroutine_threadsafe(coroutine3, new_loop)

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;iloveu&quot;</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(i)+<span class="hljs-string">&quot;    &quot;</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    main()

<span class="hljs-string">&#x27;&#x27;&#x27;è¿è¡Œç»“æœä¸ºï¼š</span>
<span class="hljs-string">i    å‡†å¤‡è°ƒç”¨func,å¤§çº¦è€—æ—¶3</span>
<span class="hljs-string">l    å‡†å¤‡è°ƒç”¨func,å¤§çº¦è€—æ—¶2</span>
<span class="hljs-string">o    å‡†å¤‡è°ƒç”¨func,å¤§çº¦è€—æ—¶1</span>
<span class="hljs-string">v</span>
<span class="hljs-string">e</span>
<span class="hljs-string">u</span>
<span class="hljs-string">è€—æ—¶1ä¹‹å,funcå‡½æ•°è¿è¡Œç»“æŸ</span>
<span class="hljs-string">è€—æ—¶2ä¹‹å,funcå‡½æ•°è¿è¡Œç»“æŸ</span>
<span class="hljs-string">è€—æ—¶3ä¹‹å,funcå‡½æ•°è¿è¡Œç»“æŸ</span>
<span class="hljs-string">&#x27;&#x27;&#x27;</span></code></pre><h3 id="Httpx-Aiohttp-ä¹‹å¼‚æ­¥è¯·æ±‚"><a href="#Httpx-Aiohttp-ä¹‹å¼‚æ­¥è¯·æ±‚" class="headerlink" title="Httpx Aiohttp ä¹‹å¼‚æ­¥è¯·æ±‚"></a>Httpx Aiohttp ä¹‹å¼‚æ­¥è¯·æ±‚</h3><ul><li><strong>aiohttp å®ç°</strong></li></ul><pre><code class="hljs python"><span class="hljs-keyword">import</span> aiohttp
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> client:
         <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> client.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>) <span class="hljs-keyword">as</span> resp:
              <span class="hljs-keyword">assert</span> resp.status == <span class="hljs-number">200</span>
              html= <span class="hljs-keyword">await</span> resp.text()
              <span class="hljs-built_in">print</span>(html)</code></pre><ul><li><strong>httpx å®ç°</strong></li></ul><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:
    resp = <span class="hljs-keyword">await</span> client.get(<span class="hljs-string">&#x27;http://httpbin.org/get&#x27;</span>)
    <span class="hljs-keyword">assert</span> resp.status_code == <span class="hljs-number">200</span>
    html = resp.text</code></pre><p>æ„Ÿè§‰æ€»ä½“ä¸Šæ¯”è¾ƒ <code>aiohttp</code> å†™èµ·æ¥èˆ’æœå¤šäº†<strong>ï¼Œå°‘å†™å¾ˆå¤šå¼‚æ­¥ä»£ç ã€‚</strong></p><blockquote><p>ä¹‹å‰ä½¿ç”¨ aiohttp ä¸­çš„ resp.status æ¥è·å–çŠ¶æ€ç çš„æ—¶å€™å†™äº† status_codeï¼Œåº”è¯¥æ˜¯ä½¿ç”¨ requests ä¹ æƒ¯äº†å§ï¼Œè¿™ä¸‹å¥½äº†ä½¿ç”¨ httpx ä¸ç”¨æ‹…å¿ƒè¿™ä¸ªå†™é”™çš„é—®é¢˜äº†ã€‚</p></blockquote><h1 id="æ·±å…¥ç†è§£-Python-åç¨‹"><a href="#æ·±å…¥ç†è§£-Python-åç¨‹" class="headerlink" title="æ·±å…¥ç†è§£ Python åç¨‹"></a>æ·±å…¥ç†è§£ Python åç¨‹</h1><blockquote><p>å‚è€ƒ: <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/asyncio.html">Python Asyncio æ–‡æ¡£</a></p></blockquote><h2 id="åç¨‹"><a href="#åç¨‹" class="headerlink" title="åç¨‹"></a>åç¨‹</h2><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># åç¨‹å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªåç¨‹å¯¹è±¡</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">say_after</span>(<span class="hljs-params">delay, what</span>):
    <span class="hljs-keyword">await</span> asyncio.sleep(delay)
    <span class="hljs-built_in">print</span>(what)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;started at <span class="hljs-subst">&#123;time.strftime(<span class="hljs-string">&#x27;%X&#x27;</span>)&#125;</span>&quot;</span>)

    <span class="hljs-comment"># ç­‰å¾…1såå†ç­‰å¾…2s,ä¸èƒ½åšåˆ°å¹¶è¡Œè¿è¡Œ</span>
    <span class="hljs-keyword">await</span> say_after(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;hello&#x27;</span>) <span class="hljs-comment"># await ç­‰å¾…åç¨‹è¿è¡Œç»“æŸ</span>
    <span class="hljs-keyword">await</span> say_after(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;world&#x27;</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;finished at <span class="hljs-subst">&#123;time.strftime(<span class="hljs-string">&#x27;%X&#x27;</span>)&#125;</span>&quot;</span>)

<span class="hljs-comment"># asyncio.run() å‡½æ•°ç”¨æ¥è¿è¡Œæœ€é«˜å±‚çº§çš„å…¥å£ç‚¹ &quot;main()&quot; å‡½æ•°</span>
asyncio.run(main())</code></pre><p><code>asyncio.create_task()</code> å‡½æ•°ç”¨æ¥è¿è¡Œä½œä¸º <code>asyncio</code> ä»»åŠ¡çš„å¤šä¸ªåç¨‹ã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    task1 = asyncio.create_task(
        say_after(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;hello&#x27;</span>))

    task2 = asyncio.create_task(
        say_after(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;world&#x27;</span>))

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;started at <span class="hljs-subst">&#123;time.strftime(<span class="hljs-string">&#x27;%X&#x27;</span>)&#125;</span>&quot;</span>)

    <span class="hljs-comment"># ç­‰å¾…ä¸¤ä¸ª task å®Œæˆ,å¹¶è¡Œè¿è¡Œ,åªéœ€è¦ 2s.</span>
    <span class="hljs-keyword">await</span> task1
    <span class="hljs-keyword">await</span> task2

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;finished at <span class="hljs-subst">&#123;time.strftime(<span class="hljs-string">&#x27;%X&#x27;</span>)&#125;</span>&quot;</span>)</code></pre><h2 id="å¯ç­‰å¾…å¯¹è±¡"><a href="#å¯ç­‰å¾…å¯¹è±¡" class="headerlink" title="å¯ç­‰å¾…å¯¹è±¡"></a>å¯ç­‰å¾…å¯¹è±¡</h2><p>å¦‚æœä¸€ä¸ªå¯¹è±¡å¯ä»¥åœ¨ <code>await</code> è¯­å¥ä¸­ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ <strong>å¯ç­‰å¾…</strong> å¯¹è±¡ã€‚</p><blockquote><p>å¯ç­‰å¾…å¯¹è±¡æœ‰ä¸‰ç§ä¸»è¦ç±»å‹: <strong>åç¨‹ coroutine</strong>, <strong>task</strong> å’Œ <strong>Future</strong>.</p></blockquote><h3 id="åç¨‹-1"><a href="#åç¨‹-1" class="headerlink" title="åç¨‹"></a>åç¨‹</h3><p><strong>åç¨‹å‡½æ•°</strong>: å®šä¹‰å½¢å¼ä¸º <code>async def</code> çš„å‡½æ•°;<br><strong>åç¨‹å¯¹è±¡</strong>: è°ƒç”¨ <strong>åç¨‹å‡½æ•°</strong> æ‰€è¿”å›çš„å¯¹è±¡ã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-comment"># åç¨‹å‡½æ•°</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">nested</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># è°ƒç”¨åç¨‹å‡½æ•°è¿”å›çš„æ˜¯åç¨‹å¯¹è±¡(coroutine object),ä¸èƒ½è¿è¡Œ</span>
    nested()

    <span class="hljs-comment"># åç¨‹é€šè¿‡ await å¯ç­‰å¾…çš„æ–¹å¼è¿è¡Œ</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> nested())

asyncio.run(main())</code></pre><h3 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h3><p><strong>ä»»åŠ¡</strong>: è¢«ç”¨æ¥ â€œå¹¶è¡Œçš„â€ è°ƒåº¦åç¨‹<br>å½“ä¸€ä¸ªåç¨‹é€šè¿‡ <code>asyncio.create_task(coro,*,name=None)</code> ç­‰å‡½æ•°è¢«å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡ï¼Œè¯¥åç¨‹ä¼šè¢« <strong>è‡ªåŠ¨è°ƒåº¦</strong> æ‰§è¡Œ:</p><p>è¯¥ä»»åŠ¡ä¼šåœ¨ <code>get_running_loop()</code> è¿”å›çš„å¾ªç¯ä¸­æ‰§è¡Œï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰åœ¨è¿è¡Œçš„å¾ªç¯åˆ™ä¼šå¼•å‘ <strong>RuntimeError</strong>ã€‚</p><p><code>task.add_done_callback(func)</code> è®¾ç½®ä»»åŠ¡å®Œæˆçš„å›è°ƒå‡½æ•°</p><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">nested</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># å°†åç¨‹å°è£…æˆä¸€ä¸ªä»»åŠ¡</span>
    task = asyncio.create_task(nested())

    <span class="hljs-comment"># ç­‰å¾…ç›´åˆ°å®ƒå®Œæˆ</span>
    <span class="hljs-keyword">await</span> task

asyncio.run(main())</code></pre><p><code>create_task</code> ä¼šæŠŠå¯ç­‰å¾…å¯¹è±¡è¢«å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡,è¯¥åç¨‹ä¼šè¢« <strong>è‡ªåŠ¨è°ƒåº¦</strong> æ‰§è¡Œ,æ‰€ä»¥ä¸ç”¨ <code>await</code></p><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">wait</span>(<span class="hljs-params">times: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ç­‰å¾…<span class="hljs-subst">&#123;times&#125;</span>s&quot;</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(times)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ç­‰å¾…ç»“æŸ!&quot;</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># asyncio.wait_for(wait(3), 2) ä¸ await å°±å‡ºé”™: RuntimeWarning: coroutine &#x27;wait_for&#x27; was never awaited</span>

    <span class="hljs-comment"># create_task ä¼šæŠŠå¯ç­‰å¾…å¯¹è±¡è¢«å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡ï¼Œè¯¥åç¨‹ä¼šè¢« **è‡ªåŠ¨è°ƒåº¦** æ‰§è¡Œ,</span>
    <span class="hljs-comment"># æ‰€ä»¥ä¸ç”¨ await ä¹Ÿèƒ½æ‰§è¡Œ, await äº†å°±è¡¨ç¤ºç­‰å¾…è¿™ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆ!</span>

    asyncio.create_task(asyncio.sleep(<span class="hljs-number">5</span>))
    <span class="hljs-keyword">await</span> asyncio.create_task(wait(<span class="hljs-number">100</span>))  <span class="hljs-comment"># å¯ç”¨äºå µå¡äº‹ä»¶å¾ªç¯,ä¸é€€å‡º</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    asyncio.run(main())</code></pre><h3 id="Futures"><a href="#Futures" class="headerlink" title="Futures"></a>Futures</h3><p><code>Future</code> æ˜¯ä¸€ç§ç‰¹æ®Šçš„ ä½å±‚çº§ å¯ç­‰å¾…å¯¹è±¡ï¼Œè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ <strong>æœ€ç»ˆç»“æœ</strong>ã€‚</p><p><strong>é€šå¸¸æƒ…å†µä¸‹æ²¡æœ‰å¿…è¦åœ¨åº”ç”¨å±‚çº§çš„ä»£ç ä¸­åˆ›å»º â€‹<code>Future</code> å¯¹è±¡ã€‚</strong></p><h2 id="è¿è¡Œ-Asyncio-åç¨‹"><a href="#è¿è¡Œ-Asyncio-åç¨‹" class="headerlink" title="è¿è¡Œ Asyncio åç¨‹"></a>è¿è¡Œ Asyncio åç¨‹</h2><p><code>asyncio.run(coro, *, debug=False)</code></p><p>æ‰§è¡Œ <code>coroutine coro</code> å¹¶è¿”å›ç»“æœã€‚<br>æ­¤å‡½æ•°ä¼šè¿è¡Œä¼ å…¥çš„åç¨‹ï¼Œè´Ÿè´£ç®¡ç† asyncio äº‹ä»¶å¾ªç¯ï¼Œç»ˆç»“å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œå¹¶å…³é—­çº¿ç¨‹æ± ã€‚</p><p>å½“æœ‰å…¶ä»– <code>asyncio</code> äº‹ä»¶å¾ªç¯åœ¨åŒä¸€çº¿ç¨‹ä¸­è¿è¡Œæ—¶ï¼Œæ­¤å‡½æ•°ä¸èƒ½è¢«è°ƒç”¨ã€‚</p><p>å¦‚æœ debug ä¸º Trueï¼Œäº‹ä»¶å¾ªç¯å°†ä»¥è°ƒè¯•æ¨¡å¼è¿è¡Œã€‚</p><p><strong>æ­¤å‡½æ•°æ€»æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯å¹¶åœ¨ç»“æŸæ—¶å…³é—­ä¹‹ã€‚å®ƒåº”å½“è¢«ç”¨ä½œ asyncio ç¨‹åºçš„ä¸»å…¥å£ç‚¹ï¼Œç†æƒ³æƒ…å†µä¸‹åº”å½“åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</strong></p><h2 id="å¹¶å‘è¿è¡Œä»»åŠ¡"><a href="#å¹¶å‘è¿è¡Œä»»åŠ¡" class="headerlink" title="å¹¶å‘è¿è¡Œä»»åŠ¡"></a>å¹¶å‘è¿è¡Œä»»åŠ¡</h2><p><code>asyncio.gather(*aws, return_exceptions=False)</code></p><p>å¹¶å‘è¿è¡Œ aws åºåˆ—ä¸­çš„å¯ç­‰å¾…å¯¹è±¡ã€‚<br>å¦‚æœ aws ä¸­çš„æŸä¸ªå¯ç­‰å¾…å¯¹è±¡ä¸ºåç¨‹ï¼Œå®ƒå°†è‡ªåŠ¨è¢«ä½œä¸ºä¸€ä¸ªä»»åŠ¡ (asyncio.create_task) è°ƒåº¦ã€‚</p><p>å¦‚æœ <code>return_exceptions</code> ä¸º False (é»˜è®¤)ï¼Œæ‰€å¼•å‘çš„é¦–ä¸ªå¼‚å¸¸ä¼šç«‹å³ä¼ æ’­ç»™<strong>ç­‰å¾… gather() çš„ä»»åŠ¡</strong>ã€‚aws åºåˆ—ä¸­çš„å…¶ä»–å¯ç­‰å¾…å¯¹è±¡ ä¸ä¼šè¢«å–æ¶ˆ å¹¶å°†ç»§ç»­è¿è¡Œã€‚</p><p>å¦‚æœ return_exceptions ä¸º Trueï¼Œå¼‚å¸¸ä¼šå’ŒæˆåŠŸçš„ç»“æœä¸€æ ·å¤„ç†ï¼Œå¹¶èšåˆè‡³ç»“æœåˆ—è¡¨ã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio


<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">name, number</span>):
    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®— number! é˜¶ä¹˜å¹¶è¿”å›</span>
<span class="hljs-string">    example: 3!=1*2*3</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>
    <span class="hljs-comment"># æµ‹è¯•å¦‚æœå‡ºç°å¼‚å¸¸</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;error&quot;</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä»»åŠ¡å:<span class="hljs-subst">&#123;name&#125;</span> å‡ºç°å¼‚å¸¸!&quot;</span>)
        <span class="hljs-keyword">raise</span> EOFError
    f = <span class="hljs-number">1</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, number + <span class="hljs-number">1</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä»»åŠ¡å:<span class="hljs-subst">&#123;name&#125;</span>:è®¡ç®—é˜¶ä¹˜(<span class="hljs-subst">&#123;number&#125;</span>), i=<span class="hljs-subst">&#123;i&#125;</span>...&quot;</span>)
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># await ä½¿åç¨‹ç­‰å¾…,è®©å‡ºç»™å…¶ä»–åç¨‹ä½¿ç”¨</span>
        f *= i
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä»»åŠ¡å<span class="hljs-subst">&#123;name&#125;</span>: <span class="hljs-subst">&#123;number&#125;</span>! = <span class="hljs-subst">&#123;f&#125;</span>&quot;</span>)
    <span class="hljs-keyword">return</span> f

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># gather ä¸€èµ·æ‰§è¡Œå¯ç­‰å¾…å¯¹è±¡,å¹¶æŒ‰è°ƒç”¨é¡ºåºè¿”å›</span>
    <span class="hljs-comment"># gather ä¼šé˜»å¡ç›´åˆ° gather ä¸­çš„æ‰€æœ‰å¯ç­‰å¾…å¯¹è±¡å®Œæˆ</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;async start!&quot;</span>)
    L = <span class="hljs-keyword">await</span> asyncio.gather(
        factorial(<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-literal">None</span>),
        factorial(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-number">2</span>),
        factorial(<span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-number">3</span>),
        factorial(<span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-number">4</span>), return_exceptions=<span class="hljs-literal">False</span>
    )
    <span class="hljs-comment"># å½“ return_exceptions ä¸º False æ—¶å¼•å‘çš„é¦–ä¸ªå¼‚å¸¸ä¼šä¼ æ’­ç»™ gather å¯ç­‰å¾…å¯¹è±¡åˆ—è¡¨çš„ä»»åŠ¡</span>
    <span class="hljs-comment"># æ•´ä¸ªç¨‹åºåœæ‘†,æœªæ‰§è¡Œå®Œçš„å¯ç­‰å¾…å¯¹è±¡ä¹Ÿä¼šå–æ¶ˆ</span>

    <span class="hljs-comment"># å½“ return_exceptions ä¸º Trueï¼Œå¼‚å¸¸ä¼šå’ŒæˆåŠŸçš„ç»“æœä¸€æ ·å¤„ç†ï¼Œå¹¶èšåˆè‡³ç»“æœåˆ—è¡¨ã€‚</span>
    <span class="hljs-comment"># å¹¶ä¸ä¼šå¼•å‘æ•´ä¸ªç¨‹åºçš„å¼‚å¸¸</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;async result:<span class="hljs-subst">&#123;L&#125;</span>&quot;</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;async end....&quot;</span>)

asyncio.run(main())</code></pre><p>å¦‚æœ gather æœ¬èº«è¢«å–æ¶ˆï¼Œåˆ™æ— è®º <code>return_exceptions</code> å–å€¼ä¸ºä½•ï¼Œæ¶ˆæ¯éƒ½ä¼šè¢«ä¼ æ’­ã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;error&quot;</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ä»»åŠ¡å:<span class="hljs-subst">&#123;name&#125;</span> å‡ºç°å¼‚å¸¸!&quot;</span>)
    gather_waiting_object.cancel()  <span class="hljs-comment"># å–æ¶ˆ gather</span>

<span class="hljs-comment"># é”™è¯¯: asyncio.exceptions.CancelledError</span></code></pre><h2 id="è¶…æ—¶"><a href="#è¶…æ—¶" class="headerlink" title="è¶…æ—¶"></a>è¶…æ—¶</h2><p>åç¨‹ (å¯ç­‰å¾…å¯¹è±¡) <code>asyncio.wait_for(aw, timeout)</code></p><p>ç­‰å¾… aw å¯ç­‰å¾…å¯¹è±¡ å®Œæˆï¼ŒæŒ‡å®š <code>timeout</code> ç§’æ•°åè¶…æ—¶ã€‚<br>å¦‚æœ aw æ˜¯ä¸€ä¸ªåç¨‹ï¼Œå®ƒå°†è‡ªåŠ¨è¢«ä½œä¸ºä»»åŠ¡ ((asyncio.create_task)) è°ƒåº¦ã€‚<br><code>timeout</code> å¯ä»¥ä¸º Noneï¼Œä¹Ÿå¯ä»¥ä¸º float æˆ– int å‹æ•°å€¼è¡¨ç¤ºçš„ç­‰å¾…ç§’æ•°ã€‚å¦‚æœ timeout ä¸º Noneï¼Œåˆ™ç­‰å¾…ç›´åˆ°å®Œæˆã€‚</p><p>å¦‚æœå‘ç”Ÿè¶…æ—¶ï¼Œä»»åŠ¡å°†å–æ¶ˆå¹¶å¼•å‘ asyncio.TimeoutError.</p><p>è¦é¿å…ä»»åŠ¡ å–æ¶ˆï¼Œå¯ä»¥åŠ ä¸Š shield()ã€‚</p><p>æ­¤å‡½æ•°å°†ç­‰å¾…ç›´åˆ° Future ç¡®å®è¢«å–æ¶ˆï¼Œæ‰€ä»¥æ€»ç­‰å¾…æ—¶é—´å¯èƒ½è¶…è¿‡ timeoutã€‚ å¦‚æœåœ¨å–æ¶ˆæœŸé—´å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼‚å¸¸å°†ä¼šè¢«ä¼ æ’­ã€‚</p><p>å¦‚æœç­‰å¾…è¢«å–æ¶ˆï¼Œåˆ™ aw æŒ‡å®šçš„å¯¹è±¡ä¹Ÿä¼šè¢«å–æ¶ˆã€‚</p><h2 id="ç®€å•ç­‰å¾…"><a href="#ç®€å•ç­‰å¾…" class="headerlink" title="ç®€å•ç­‰å¾…"></a>ç®€å•ç­‰å¾…</h2><p>coroutine <code>asyncio.wait(aws, *, timeout=None, return_when=ALL_COMPLETED)</code></p><p>å¹¶å‘åœ°è¿è¡Œ aws å¯è¿­ä»£å¯¹è±¡ä¸­çš„ <code>å¯ç­‰å¾…å¯¹è±¡</code>(ä¸èƒ½ç›´æ¥ä¼ å…¥åç¨‹å¯¹è±¡éœ€è¦è½¬æ¢ä¸º Task) å¹¶è¿›å…¥é˜»å¡çŠ¶æ€ç›´åˆ°æ»¡è¶³ return_when æ‰€æŒ‡å®šçš„æ¡ä»¶ã€‚</p><p>return_when æŒ‡å®šæ­¤å‡½æ•°åº”åœ¨ä½•æ—¶è¿”å›:</p><ul><li>FIRST_COMPLETED: åœ¨ç¬¬ä¸€ä¸ªå¯ç­‰å¾…å¯¹è±¡è¿è¡Œå®Œæ¯•åè¿”å›</li><li>FIRST_EXCEPTION: åœ¨ä»»æ„å¯ç­‰å¾…å¯¹è±¡æŠ›å‡ºå¼‚å¸¸åè¿”å›,ä¸ä¼šç»“æŸå…¶ä»–å¯ç­‰å¾…å¯¹è±¡,å¹¶åœ¨ç¨‹åºç»“æŸæœ€åæŠ›å‡ºå¼‚å¸¸</li><li>ALL_COMPLETED(é»˜è®¤): åœ¨æ‰€æœ‰å¯ç­‰å¾…å¯¹è±¡æ‰§è¡Œå®Œæ¯•åè¿”å›</li></ul><p>aws å¯è¿­ä»£å¯¹è±¡å¿…é¡»ä¸ä¸ºç©ºã€‚ è¿”å›ä¸¤ä¸ª Task&#x2F;Future é›†åˆ: (done, pending)</p><p><code>(done, panding)</code>: done: å·²å®Œæˆçš„åç¨‹;panding: æ­£åœ¨ç­‰å¾…çš„åç¨‹; æ”¯æŒé€šè¿‡ <code>if</code> åˆ¤æ–­</p><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio


<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">wait</span>(<span class="hljs-params">name, times: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;A&quot;</span>:
        <span class="hljs-keyword">raise</span> EOFError
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span>ç­‰å¾…<span class="hljs-subst">&#123;times&#125;</span>s&quot;</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(times)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span>ç­‰å¾…ç»“æŸ!&quot;</span>)
    <span class="hljs-keyword">return</span> times


<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():

    task, pending = <span class="hljs-keyword">await</span> asyncio.wait(
        (
            wait(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-number">3</span>),
            wait(<span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-number">2</span>),
            wait(<span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-number">1</span>)
        ), return_when=asyncio.FIRST_COMPLETED
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å·²å®Œæˆ:&quot;</span>, task, <span class="hljs-string">&quot;\nç­‰å¾…:&quot;</span>, pending)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">5</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æŠ›å‡ºå¼‚å¸¸&quot;</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    asyncio.run(main())</code></pre><p>(å’Œç”·æœ‹å‹å‡ºå»å–å¥¶èŒ¶äº†,æœªå®Œå¾…ç»­,å¯èƒ½ä¼šç»§ç»­å†™ä¸€äº›åº”ç”¨åœºæ™¯,æˆ–è€…å’Œ Golang çš„ Goruntine è¿›è¡Œå¯¹æ¯”)â€¦â€¦..<br>2022&#x2F;8&#x2F;24 18:34</p><p>æ‰€è°“ã€Œå¼‚æ­¥ IOã€ï¼Œå°±æ˜¯ä½ å‘èµ·ä¸€ä¸ª IO æ“ä½œï¼Œå´ä¸ç”¨ç­‰å®ƒç»“æŸï¼Œä½ å¯ä»¥ç»§ç»­åšå…¶ä»–äº‹æƒ…ï¼Œå½“å®ƒç»“æŸæ—¶ï¼Œä½ ä¼šå¾—åˆ°é€šçŸ¥ã€‚</p><p>Asyncio æ˜¯å¹¶å‘ï¼ˆconcurrencyï¼‰çš„ä¸€ç§æ–¹å¼ã€‚å¯¹ Python æ¥è¯´ï¼Œå¹¶å‘è¿˜å¯ä»¥é€šè¿‡çº¿ç¨‹ï¼ˆthreadingï¼‰å’Œå¤šè¿›ç¨‹ï¼ˆmultiprocessingï¼‰æ¥å®ç°ã€‚</p><p>Asyncio å¹¶ä¸èƒ½å¸¦æ¥çœŸæ­£çš„å¹¶è¡Œï¼ˆparallelismï¼‰ã€‚å½“ç„¶ï¼Œå› ä¸º GILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰çš„å­˜åœ¨ï¼ŒPython çš„å¤šçº¿ç¨‹ä¹Ÿä¸èƒ½å¸¦æ¥çœŸæ­£çš„å¹¶è¡Œã€‚</p><p>å¯äº¤ç»™ asyncio æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç§°ä¸ºåç¨‹ï¼ˆcoroutineï¼‰ã€‚ä¸€ä¸ªåç¨‹å¯ä»¥æ”¾å¼ƒæ‰§è¡Œï¼ŒæŠŠæœºä¼šè®©ç»™å…¶å®ƒåç¨‹ï¼ˆå³Â <code>yield from</code>Â æˆ–Â <code>await</code>ï¼‰ã€‚&#96;</p><h2 id="å®šä¹‰åç¨‹"><a href="#å®šä¹‰åç¨‹" class="headerlink" title="å®šä¹‰åç¨‹"></a>å®šä¹‰åç¨‹</h2><p>åç¨‹çš„å®šä¹‰ï¼Œéœ€è¦ä½¿ç”¨Â <code>async def</code>Â è¯­å¥ã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_some_work</span>(<span class="hljs-params">x</span>):
	<span class="hljs-keyword">pass</span></code></pre><p><code>do_some_work</code>Â ä¾¿æ˜¯ä¸€ä¸ªåç¨‹ã€‚<br>å‡†ç¡®æ¥è¯´ï¼Œ<code>do_some_work</code>Â æ˜¯ä¸€ä¸ªåç¨‹å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡Â <code>asyncio.iscoroutinefunction</code>Â æ¥éªŒè¯ï¼š</p><pre><code class="hljs python"><span class="hljs-built_in">print</span>(asyncio.iscoroutinefunction(do_some_work)) <span class="hljs-comment"># True</span></code></pre><p>è¿™ä¸ªåç¨‹ä»€ä¹ˆéƒ½æ²¡åšï¼Œæˆ‘ä»¬è®©å®ƒç¡çœ å‡ ç§’ï¼Œä»¥æ¨¡æ‹Ÿå®é™…çš„å·¥ä½œé‡ ï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_some_work</span>(<span class="hljs-params">x</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Waiting &quot;</span> + <span class="hljs-built_in">str</span>(x))
    <span class="hljs-keyword">await</span> asyncio.sleep(x)</code></pre><p>åœ¨è§£é‡ŠÂ <code>await</code>Â ä¹‹å‰ï¼Œæœ‰å¿…è¦è¯´æ˜ä¸€ä¸‹åç¨‹å¯ä»¥åšå“ªäº›äº‹ã€‚åç¨‹å¯ä»¥ï¼š</p><ul><li>ç­‰å¾…ä¸€ä¸ª future ç»“æŸ</li><li>ç­‰å¾…å¦ä¸€ä¸ªåç¨‹ï¼ˆäº§ç”Ÿä¸€ä¸ªç»“æœï¼Œæˆ–å¼•å‘ä¸€ä¸ªå¼‚å¸¸ï¼‰</li><li>äº§ç”Ÿä¸€ä¸ªç»“æœç»™æ­£åœ¨ç­‰å®ƒçš„åç¨‹</li><li>å¼•å‘ä¸€ä¸ªå¼‚å¸¸ç»™æ­£åœ¨ç­‰å®ƒçš„åç¨‹</li></ul><p><code>asyncio.sleep</code>Â ä¹Ÿæ˜¯ä¸€ä¸ªåç¨‹ï¼Œæ‰€ä»¥Â <code>await asyncio.sleep(x)</code>Â å°±æ˜¯ç­‰å¾…å¦ä¸€ä¸ªåç¨‹ã€‚å¯å‚è§Â <code>asyncio.sleep</code>Â çš„æ–‡æ¡£ï¼š</p><pre><code class="hljs python">sleep(delay, result=<span class="hljs-literal">None</span>, *, loop=<span class="hljs-literal">None</span>)

<span class="hljs-comment"># Coroutine that completes after a given time (in seconds).</span></code></pre><h2 id="è¿è¡Œåç¨‹"><a href="#è¿è¡Œåç¨‹" class="headerlink" title="è¿è¡Œåç¨‹"></a>è¿è¡Œåç¨‹</h2><p>è°ƒç”¨åç¨‹å‡½æ•°ï¼Œåç¨‹å¹¶ä¸ä¼šå¼€å§‹è¿è¡Œï¼Œåªæ˜¯è¿”å›ä¸€ä¸ªåç¨‹å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡Â <code>asyncio.iscoroutine</code>Â æ¥éªŒè¯ï¼š</p><pre><code class="hljs python"><span class="hljs-built_in">print</span>(asyncio.iscoroutine(do_some_work(<span class="hljs-number">3</span>))) <span class="hljs-comment"># True</span></code></pre><p>æ­¤å¤„è¿˜ä¼šå¼•å‘ä¸€æ¡è­¦å‘Šï¼š</p><pre><code class="hljs text">async1.py:16: RuntimeWarning: coroutine &#x27;do_some_work&#x27; was never awaited
  print(asyncio.iscoroutine(do_some_work(3)))</code></pre><p>è¦è®©è¿™ä¸ªåç¨‹å¯¹è±¡è¿è¡Œçš„è¯ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>åœ¨å¦ä¸€ä¸ªå·²ç»è¿è¡Œçš„åç¨‹ä¸­ç”¨ <code>await</code> ç­‰å¾…å®ƒ</li><li>é€šè¿‡ <code>ensure_future</code> å‡½æ•°è®¡åˆ’å®ƒçš„æ‰§è¡Œ</li></ul><p>ç®€å•æ¥è¯´ï¼Œåªæœ‰ loop è¿è¡Œäº†ï¼Œåç¨‹æ‰å¯èƒ½è¿è¡Œã€‚<br>ä¸‹é¢å…ˆæ‹¿åˆ°å½“å‰çº¿ç¨‹ç¼ºçœçš„ loop ï¼Œç„¶åæŠŠåç¨‹å¯¹è±¡äº¤ç»™Â <code>loop.run_until_complete</code>ï¼Œåç¨‹å¯¹è±¡éšåä¼šåœ¨ loop é‡Œå¾—åˆ°è¿è¡Œã€‚</p><pre><code class="hljs python">loop = asyncio.get_event_loop()
loop.run_until_complete(do_some_work(<span class="hljs-number">3</span>))</code></pre><p><code>run_until_complete</code>Â æ˜¯ä¸€ä¸ªé˜»å¡ï¼ˆblockingï¼‰è°ƒç”¨ï¼Œç›´åˆ°åç¨‹è¿è¡Œç»“æŸï¼Œå®ƒæ‰è¿”å›ã€‚è¿™ä¸€ç‚¹ä»å‡½æ•°åä¸éš¾çœ‹å‡ºã€‚<br><code>run_until_complete</code>Â çš„å‚æ•°æ˜¯ä¸€ä¸ª futureï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¼ ç»™å®ƒçš„å´æ˜¯åç¨‹å¯¹è±¡ï¼Œä¹‹æ‰€ä»¥èƒ½è¿™æ ·ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨å†…éƒ¨åšäº†æ£€æŸ¥ï¼Œé€šè¿‡Â <code>ensure_future</code>Â å‡½æ•°æŠŠåç¨‹å¯¹è±¡åŒ…è£…ï¼ˆwrapï¼‰æˆäº† futureã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å†™å¾—æ›´æ˜æ˜¾ä¸€äº›ï¼š</p><pre><code class="hljs python">loop.run_until_complete(asyncio.ensure_future(do_some_work(<span class="hljs-number">3</span>)))</code></pre><p>å®Œæ•´ä»£ç ï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_some_work</span>(<span class="hljs-params">x</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Waiting &quot;</span> + <span class="hljs-built_in">str</span>(x))
    <span class="hljs-keyword">await</span> asyncio.sleep(x)

loop = asyncio.get_event_loop()
loop.run_until_complete(do_some_work(<span class="hljs-number">3</span>))</code></pre><p>è¿è¡Œç»“æœï¼š</p><p>Waiting 3<br>&lt;ä¸‰ç§’é’Ÿåç¨‹åºç»“æŸ&gt;</p><h2 id="å›è°ƒ"><a href="#å›è°ƒ" class="headerlink" title="å›è°ƒ"></a>å›è°ƒ</h2><p>å‡å¦‚åç¨‹æ˜¯ä¸€ä¸ª IO çš„è¯»æ“ä½œï¼Œç­‰å®ƒè¯»å®Œæ•°æ®åï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°é€šçŸ¥ï¼Œä»¥ä¾¿ä¸‹ä¸€æ­¥æ•°æ®çš„å¤„ç†ã€‚è¿™ä¸€éœ€æ±‚å¯ä»¥é€šè¿‡å¾€ future æ·»åŠ å›è°ƒæ¥å®ç°ã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">done_callback</span>(<span class="hljs-params">futu</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Done&#x27;</span>)

futu = asyncio.ensure_future(do_some_work(<span class="hljs-number">3</span>))
futu.add_done_callback(done_callback)

loop.run_until_complete(futu)</code></pre><h2 id="å¤šä¸ªåç¨‹"><a href="#å¤šä¸ªåç¨‹" class="headerlink" title="å¤šä¸ªåç¨‹"></a>å¤šä¸ªåç¨‹</h2><p>å®é™…é¡¹ç›®ä¸­ï¼Œå¾€å¾€æœ‰å¤šä¸ªåç¨‹ï¼ŒåŒæ—¶åœ¨ä¸€ä¸ª loop é‡Œè¿è¡Œã€‚ä¸ºäº†æŠŠå¤šä¸ªåç¨‹äº¤ç»™ loopï¼Œéœ€è¦å€ŸåŠ©Â <code>asyncio.gather</code>Â å‡½æ•°ã€‚</p><pre><code class="hljs python">loop.run_until_complete(asyncio.gather(do_some_work(<span class="hljs-number">1</span>), do_some_work(<span class="hljs-number">3</span>)))</code></pre><p>æˆ–è€…å…ˆæŠŠåç¨‹å­˜åœ¨åˆ—è¡¨é‡Œï¼š</p><pre><code class="hljs python">coros = [do_some_work(<span class="hljs-number">1</span>), do_some_work(<span class="hljs-number">3</span>)]
loop.run_until_complete(asyncio.gather(*coros))</code></pre><p>è¿è¡Œç»“æœï¼š</p><pre><code class="hljs text">Waiting 3
Waiting 1
&lt;ç­‰å¾…ä¸‰ç§’é’Ÿ&gt;
Done</code></pre><p>è¿™ä¸¤ä¸ªåç¨‹æ˜¯å¹¶å‘è¿è¡Œçš„ï¼Œæ‰€ä»¥ç­‰å¾…çš„æ—¶é—´ä¸æ˜¯ 1 + 3 &#x3D; 4 ç§’ï¼Œè€Œæ˜¯ä»¥è€—æ—¶è¾ƒé•¿çš„é‚£ä¸ªåç¨‹ä¸ºå‡†ã€‚</p><p>å‚è€ƒå‡½æ•°Â <code>gather</code>Â çš„æ–‡æ¡£ï¼š</p><pre><code class="hljs text">gather(*coros_or_futures, loop=None, return_exceptions=False)

Return a future aggregating results from the given coroutines or futures.
è¿”å›æ¥è‡ªç»™å®šåç¨‹æˆ– `futures` çš„ `future` èšåˆç»“æœã€‚</code></pre><p>å‘ç°ä¹Ÿå¯ä»¥ä¼  futures ç»™å®ƒï¼š</p><pre><code class="hljs python">futus = [
	asyncio.ensure_future(do_some_work(<span class="hljs-number">1</span>)),
    asyncio.ensure_future(do_some_work(<span class="hljs-number">3</span>))
]

loop.run_until_complete(asyncio.gather(*futus))</code></pre><p><code>gather</code>Â èµ·èšåˆçš„ä½œç”¨ï¼ŒæŠŠå¤šä¸ª futures åŒ…è£…æˆå•ä¸ª futureï¼Œå› ä¸ºÂ <code>loop.run_until_complete</code>Â åªæ¥å—å•ä¸ª futureã€‚</p><h2 id="run-until-complete-å’Œ-run-forever"><a href="#run-until-complete-å’Œ-run-forever" class="headerlink" title="run_until_complete å’Œ run_forever"></a>run_until_complete å’Œ run_forever</h2><p>æˆ‘ä»¬ä¸€ç›´é€šè¿‡Â <code>run_until_complete</code>Â æ¥è¿è¡Œ loop ï¼Œç­‰åˆ° future å®Œæˆï¼Œ<code>run_until_complete</code>Â ä¹Ÿå°±è¿”å›äº†ã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_some_work</span>(<span class="hljs-params">x</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Waiting &#x27;</span> + <span class="hljs-built_in">str</span>(x))
    <span class="hljs-keyword">await</span> asyncio.sleep(x)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Done&#x27;</span>)

loop = asyncio.get_event_loop()

coro = do_some_work(<span class="hljs-number">3</span>)
loop.run_until_complete(coro)</code></pre><p>è¾“å‡ºï¼š</p><pre><code class="hljs test">Waiting 3
&lt;ç­‰å¾…ä¸‰ç§’é’Ÿ&gt;
Done
&lt;ç¨‹åºé€€å‡º&gt;</code></pre><p>ç°åœ¨æ”¹ç”¨Â <code>run_forever</code>ï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_some_work</span>(<span class="hljs-params">x</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Waiting &#x27;</span> + <span class="hljs-built_in">str</span>(x))
    <span class="hljs-keyword">await</span> asyncio.sleep(x)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Done&#x27;</span>)

loop = asyncio.get_event_loop()

coro = do_some_work(<span class="hljs-number">3</span>)
asyncio.ensure_future(coro)

loop.run_forever()</code></pre><p>è¾“å‡ºï¼š</p><pre><code class="hljs text">Waiting 3
&lt;ç­‰å¾…ä¸‰ç§’é’Ÿ&gt;
Done
&lt;ç¨‹åºæ²¡æœ‰é€€å‡º&gt;</code></pre><p>ä¸‰ç§’é’Ÿè¿‡åï¼Œfuture ç»“æŸï¼Œä½†æ˜¯ç¨‹åºå¹¶ä¸ä¼šé€€å‡ºã€‚<code>run_forever</code>Â ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°Â <code>stop</code>Â è¢«è°ƒç”¨ï¼Œä½†æ˜¯ä½ ä¸èƒ½åƒä¸‹é¢è¿™æ ·è°ƒÂ <code>stop</code>ï¼š</p><pre><code class="hljs python">loop.run_forever()
loop.stop()</code></pre><p><code>run_forever</code>Â ä¸è¿”å›ï¼Œ<code>stop</code>Â æ°¸è¿œä¹Ÿä¸ä¼šè¢«è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œåªèƒ½åœ¨åç¨‹ä¸­è°ƒÂ <code>stop</code>ï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_some_work</span>(<span class="hljs-params">loop, x</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Waiting &#x27;</span> + <span class="hljs-built_in">str</span>(x))
    <span class="hljs-keyword">await</span> asyncio.sleep(x)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Done&#x27;</span>)
    loop.stop()</code></pre><p>è¿™æ ·å¹¶éæ²¡æœ‰é—®é¢˜ï¼Œå‡å¦‚æœ‰å¤šä¸ªåç¨‹åœ¨ loop é‡Œè¿è¡Œï¼š</p><pre><code class="hljs python">asyncio.ensure_future(do_some_work(loop, <span class="hljs-number">1</span>))
asyncio.ensure_future(do_some_work(loop, <span class="hljs-number">3</span>))

loop.run_forever()</code></pre><p>ç¬¬äºŒä¸ªåç¨‹æ²¡ç»“æŸï¼Œloop å°±åœæ­¢äº†â€”â€”è¢«å…ˆç»“æŸçš„é‚£ä¸ªåç¨‹ç»™åœæ‰çš„ã€‚<br>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ç”¨Â <code>gather</code>Â æŠŠå¤šä¸ªåç¨‹åˆå¹¶æˆä¸€ä¸ª futureï¼Œå¹¶æ·»åŠ å›è°ƒï¼Œç„¶ååœ¨å›è°ƒé‡Œå†å»åœæ­¢ loopã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_some_work</span>(<span class="hljs-params">loop, x</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Waiting &#x27;</span> + <span class="hljs-built_in">str</span>(x))
    <span class="hljs-keyword">await</span> asyncio.sleep(x)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Done&#x27;</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">done_callback</span>(<span class="hljs-params">loop, futu</span>):
    loop.stop()

loop = asyncio.get_event_loop()

futus = asyncio.gather(do_some_work(loop, <span class="hljs-number">1</span>), do_some_work(loop, <span class="hljs-number">3</span>))
futus.add_done_callback(functools.partial(done_callback, loop))

loop.run_forever()</code></pre><p>å…¶å®è¿™åŸºæœ¬ä¸Šå°±æ˜¯Â <code>run_until_complete</code>Â çš„å®ç°äº†ï¼Œ<code>run_until_complete</code>Â åœ¨å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨Â <code>run_forever</code>ã€‚</p><h2 id="Close-Loop"><a href="#Close-Loop" class="headerlink" title="Close Loop?"></a>Close Loop?</h2><p>ä»¥ä¸Šç¤ºä¾‹éƒ½æ²¡æœ‰è°ƒç”¨Â <code>loop.close</code>ï¼Œå¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚æ‰€ä»¥åˆ°åº•è¦ä¸è¦è°ƒÂ <code>loop.close</code>Â å‘¢ï¼Ÿ<br>ç®€å•æ¥è¯´ï¼Œloop åªè¦ä¸å…³é—­ï¼Œå°±è¿˜å¯ä»¥å†è¿è¡Œã€‚ï¼š</p><pre><code class="hljs python">loop.run_until_complete(do_some_work(loop, <span class="hljs-number">1</span>))
loop.run_until_complete(do_some_work(loop, <span class="hljs-number">3</span>))
loop.close()</code></pre><p>ä½†æ˜¯å¦‚æœå…³é—­äº†ï¼Œå°±ä¸èƒ½å†è¿è¡Œäº†ï¼š</p><pre><code class="hljs python">loop.run_until_complete(do_some_work(loop, <span class="hljs-number">1</span>))
loop.close()
loop.run_until_complete(do_some_work(loop, <span class="hljs-number">3</span>)) <span class="hljs-comment"># æ­¤å¤„å¼‚å¸¸</span></code></pre><p>å»ºè®®è°ƒç”¨Â <code>loop.close</code>ï¼Œä»¥å½»åº•æ¸…ç† loop å¯¹è±¡é˜²æ­¢è¯¯ç”¨ã€‚</p><h2 id="Gather-vs-wait"><a href="#Gather-vs-wait" class="headerlink" title="Gather vs. wait"></a>Gather vs. wait</h2><p><code>asyncio.gather</code>Â å’ŒÂ <code>asyncio.wait</code>Â åŠŸèƒ½ç›¸ä¼¼ã€‚</p><pre><code class="hljs python">coros = [do_some_work(loop, <span class="hljs-number">1</span>), do_some_work(loop, <span class="hljs-number">3</span>)]
loop.run_until_complete(asyncio.wait(coros))</code></pre><p>å…·ä½“å·®åˆ«å¯è¯·å‚è§ StackOverflow çš„è®¨è®ºï¼š<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/42231161/asyncio-gather-vs-asyncio-wait">python - Asyncio.gather vs asyncio.wait - Stack Overflow</a>)ã€‚</p><p>æŠ“ä½å¼‚æ­¥çš„å¼‚å¸¸ï¼š</p><pre><code class="hljs python">results = <span class="hljs-keyword">await</span> asyncio.gather(*coros, return_exceptions=<span class="hljs-literal">True</span>)
<span class="hljs-keyword">for</span> result_or_exc <span class="hljs-keyword">in</span> results:
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result_or_exc, Exception):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;I caught:&quot;</span>, <span class="hljs-built_in">repr</span>(result_or_exc))</code></pre><h2 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h2><p>C++ Boost.Asio æä¾›äº† IO å¯¹è±¡ timerï¼Œä½†æ˜¯ Python å¹¶æ²¡æœ‰åŸç”Ÿæ”¯æŒ timerï¼Œä¸è¿‡å¯ä»¥ç”¨Â <code>asyncio.sleep</code>Â æ¨¡æ‹Ÿã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">timer</span>(<span class="hljs-params">x, cb</span>):
    futu = asyncio.ensure_future(asyncio.sleep(x))
    futu.add_done_callback(cb)
    <span class="hljs-keyword">await</span> futu

t = timer(<span class="hljs-number">3</span>, <span class="hljs-keyword">lambda</span> futu: <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Done&#x27;</span>))
loop.run_until_complete(t)</code></pre></div><div class="post__license"><p><strong>Author: </strong>WhaleFall</p><p><strong>Permalink: </strong><a href="https://www.whaleluo.top/python/python-async/">https://www.whaleluo.top/python/python-async/</a></p><strong><p>æ–‡ç« é»˜è®¤ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> åè®®è¿›è¡Œè®¸å¯ï¼Œä½¿ç”¨æ—¶è¯·æ³¨æ„éµå®ˆåè®®ã€‚</p></strong></div><div class="post-footer__meta"><p>updated at 2021-08-18</p></div><div class="post-entry__tags"><a href="/tags/Coding/" class="post-tags__link button"># Coding</a><a href="/tags/Python/" class="post-tags__link button"># Python</a></div></article><div class="nav"><div class="nav__prev"><a href="/python/python-tkinter-gui/" class="nav__link"><div><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M589.088 790.624L310.464 512l278.624-278.624 45.248 45.248L400.96 512l233.376 233.376z" fill="#808080"></path></svg></div><div><div class="nav__label">Previous Post</div><div class="nav__title">Python Tkinter æ¡†æ¶å­¦ä¹ </div></div></a></div><div class="nav__next"><a href="/study/zhongkao-maths/" class="nav__link"><div><div class="nav__label">Next Post</div><div class="nav__title">ğŸ˜­2021å¹´å¹¿ä¸œæ•°å­¦ä¸­è€ƒä½“éªŒ</div></div><div><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M434.944 790.624l-45.248-45.248L623.04 512l-233.376-233.376 45.248-45.248L713.568 512z" fill="#808080"></path></svg></div></a></div></div><div class="post__comments post__with-toc content-card" id="comment"><h4>Comments</h4><div id="gitalk-container"></div></div></main><footer class="footer"><a href="#" class="button" id="b2t" aria-label="Back to Top" title="Back to Top"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="32" height="32"><path d="M233.376 722.752L278.624 768 512 534.624 745.376 768l45.248-45.248L512 444.128zM192 352h640V288H192z" fill="currentColor"></path></svg> </a><span id="busuanzi_container_site_uv" hidden><span></span> <span id="busuanzi_value_site_uv"></span> <span>Viewers</span> <span>|</span> </span><span id="busuanzi_container_site_pv" hidden><span></span> <span id="busuanzi_value_site_pv"></span> <span>Views</span></span><p class="footer-copyright">Copyright Â© 2018&nbsp;-&nbsp;2024 <a href="/">ğŸ˜Šè½è½ã®BlogğŸ˜Š</a></p><p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme - <a href="https://github.com/ChrAlpha/hexo-theme-cards" target="_blank">Cards</a></p></footer></div><script defer src="https://api.whaleluo.top/file/?url=https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script><script>window.lazyLoadOptions={elements_selector:".lazy",threshold:0}</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "e052e3fc47004feab6ae8122cfeec660"}'></script><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><script>let lazyloadT = Boolean('true'),
            auto_fancybox = Boolean('true')
        if (auto_fancybox) {
            $(".post__content").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        } else {
            $(".post__content").find("fancybox").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        }</script><script>function loadComment() {
            let e, i;
            (e = document.createElement("script")).src = 'https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js',
            document.body.appendChild(e);
            e.onload = () => {
                var gitalk = new Gitalk({
                    clientID: 'b2fd920dada050fed5b3',
                    clientSecret: '5c847cefe7df2df634886eafa178877899404378',
                    repo: 'WhaleFell.github.io',
                    owner: 'WhaleFell',
                    admin: 'WhaleFell',
                    id: window.location.pathname,
                    distractionFreeMode: false
                });
                gitalk.render('gitalk-container');
            };
            (i = document.createElement("link")).rel = "stylesheet",
            i.href = 'https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css',
            document.head.appendChild(i);
        }
    
        var runningOnBrowser = typeof window !== "undefined";
        var isBot = runningOnBrowser && !("onscroll" in window) || typeof navigator !== "undefined" && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
        var supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;
    
        setTimeout(function () {
            if (!isBot && supportsIntersectionObserver) {
                var comment_observer = new IntersectionObserver(function(entries) {
                    if (entries[0].isIntersecting) {
                        loadComment();
                        comment_observer.disconnect();
                    }
                }, { threshold: [0] });
                comment_observer.observe(document.getElementById('comment'));
            } else {
                loadComment();
            }
        }, 1);</script></body></html>